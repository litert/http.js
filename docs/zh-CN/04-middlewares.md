# 中间件

> [上一节：处理器函数](./03-handlers.md) | [返回目录](./index.md)

中间件是指在调用处理器之前进行预处理，或者在调用处理器之后进行收尾工作的函数。
为什么需要中间件呢？举个例子，你所有的请求都需要进行登陆验证，难道你要在所有的处理器
函数中都写一遍登陆验证吗？当然不想。

中间件是用来做这种事情的——在执行处理器函数之前，对请求进行预处理，或者拦截，或者在
处理器函数执行完毕之后，进行收尾工作——例如记录访问日志。

先来看看中间件函数的签名：

```ts
type RequestMiddleware = (
    context: RequestContext,
    next: (end?: boolean) => Promise<void>
) => Promise<void>;
```

与处理器函数对比下，唯一的区别就是，中间件函数的参数多了一个 next 回调函数，它的用途
是什么呢？很简单，就是调用下一个中间件函数——如果没有下一个中间件函数，那就调用处理器
函数。

> 中间件函数可以有多个，按照注册顺序调用。

可以看出 next 回调也是 async function，因此可以通过 await 等待它执行完毕，于是可以
得到函数调用堆栈图如下：（A、B、C 都是中间件）

```
Request → A → B → C
                  ↓
               Handler
                  ↓
Request ← A ← B ← C
```

对于某个中间件，在 `await next();` 之后，这个中间件后面的所有中间件函数和处理器函数
都已经调用完毕了，当前中间件就可以进行收尾工作了。

> [下一节：API 文档](./05-api-index.md) | [返回目录](./index.md)
